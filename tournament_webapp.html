<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; margin-right: 10px; }
    </style>
</head>
<body>
<div id="list-view">
    <h2>Tournaments</h2>
    <div id="tournaments-list"></div>
    <button onclick="showCreateForm()">Create New</button>
</div>

<div id="form-view" style="display:none;">
    <h2 id="form-title">Create Tournament</h2>
    <form id="tournament-form">
        <input type="hidden" id="tournament-id">

        <div class="form-group">
            <label for="event-name">Event Name</label>
            <input type="text" id="event-name" required>
        </div>

        <div class="form-group">
            <label for="event-datetime">Event Date/Time</label>
            <input type="datetime-local" id="event-datetime" required>
        </div>

        <div class="form-group">
            <label for="location-name">Location Name</label>
            <input type="text" id="location-name" required>
        </div>

        <div class="form-group">
            <label for="teams-count">Number of Teams</label>
            <input type="number" id="teams-count" min="2" onchange="updateSectors()" required>
        </div>

        <div class="form-group">
            <label for="sectors-count">Number of Sectors</label>
            <input type="number" id="sectors-count" readonly>
        </div>

        <div class="form-group">
            <label for="players-per-game">Players per Game</label>
            <input type="number" id="players-per-game" min="1" onchange="updateRegisteredPlayers()" required>
        </div>

        <div class="form-group">
            <label for="players-registered">Players Registered</label>
            <input type="number" id="players-registered" readonly>
        </div>

        <div class="form-group">
            <label for="round-robin">Rounds in Round-Robin</label>
            <input type="number" id="round-robin" value="10" required>
        </div>

        <div class="form-group">
            <label for="playoff-stage">Playoff Starts At</label>
            <select id="playoff-stage">
                <option value="1/16">1/16 Final</option>
                <option value="1/8" selected>1/8 Final</option>
                <option value="1/4">Quarter Final</option>
                <option value="1/2">Semi Final</option>
                <option value="final">Final</option>
                <option value="none">No Play-off</option>
            </select>
        </div>

        <div class="form-group">
            <label for="seeding-method">Playoff Seeding</label>
            <select id="seeding-method">
                <option value="standings" selected>Round-Robin Standings</option>
                <option value="random">Random Draw</option>
            </select>
        </div>

        <div class="form-group">
            <label for="competition-type">Competition Type</label>
            <select id="competition-type">
                <option value="team_only">Team Only</option>
                <option value="individual_also" selected>Individual Counted</option>
            </select>
        </div>

        <div class="form-group">
            <label for="comment">Comment</label>
            <textarea id="comment" rows="3"></textarea>
        </div>

        <button type="button" onclick="saveTournament()">Save</button>
        <button type="button" onclick="showListView()">Cancel</button>
        <button type="button" id="delete-btn" style="display:none;" onclick="deleteTournament()">Delete</button>
    </form>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.setText("Close").show().onClick(() => tg.close());

    function updateSectors() {
        const teams = parseInt(document.getElementById('teams-count').value) || 0;
        document.getElementById('sectors-count').value = Math.max(1, Math.floor(teams / 2));
    }

    function updateRegisteredPlayers() {
        const perGame = parseInt(document.getElementById('players-per-game').value) || 0;
        document.getElementById('players-registered').value = perGame + 1;
    }

    function showCreateForm() {
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('form-view').style.display = 'block';
        document.getElementById('form-title').textContent = 'Create Tournament';
        document.getElementById('tournament-id').value = '';
        document.getElementById('delete-btn').style.display = 'none';
        document.getElementById('tournament-form').reset();
        updateSectors();
        updateRegisteredPlayers();
    }

    function showEditForm(tournament) {
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('form-view').style.display = 'block';
        document.getElementById('form-title').textContent = 'Edit Tournament';
        document.getElementById('tournament-id').value = tournament.id;
        document.getElementById('event-name').value = tournament.event_name;
        document.getElementById('event-datetime').value = tournament.event_datetime;
        document.getElementById('location-name').value = tournament.location_name;
        document.getElementById('teams-count').value = tournament.number_of_teams;
        document.getElementById('sectors-count').value = tournament.number_of_sectors;
        document.getElementById('players-per-game').value = tournament.players_per_game;
        document.getElementById('players-registered').value = tournament.players_registered;
        document.getElementById('round-robin').value = tournament.round_robin_rounds;
        document.getElementById('playoff-stage').value = tournament.playoff_starts_at;
        document.getElementById('seeding-method').value = tournament.playoff_seeding;
        document.getElementById('competition-type').value = tournament.competition_type;
        document.getElementById('comment').value = tournament.comment || '';
        document.getElementById('delete-btn').style.display = 'inline-block';
    }

    function showListView() {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('form-view').style.display = 'none';
        loadTournaments();
    }

    function loadTournaments() {
        tg.sendData(JSON.stringify({ action: 'list_tournaments' }));
    }

    function saveTournament() {
        const formData = {
            id: document.getElementById('tournament-id').value,
            event_name: document.getElementById('event-name').value,
            event_datetime: document.getElementById('event-datetime').value,
            location_name: document.getElementById('location-name').value,
            number_of_teams: parseInt(document.getElementById('teams-count').value),
            number_of_sectors: parseInt(document.getElementById('sectors-count').value),
            players_per_game: parseInt(document.getElementById('players-per-game').value),
            players_registered: parseInt(document.getElementById('players-registered').value),
            round_robin_rounds: parseInt(document.getElementById('round-robin').value),
            playoff_starts_at: document.getElementById('playoff-stage').value,
            playoff_seeding: document.getElementById('seeding-method').value,
            competition_type: document.getElementById('competition-type').value,
            comment: document.getElementById('comment').value
        };

        tg.sendData(JSON.stringify({
            action: document.getElementById('tournament-id').value ? 'update_tournament' : 'create_tournament',
            data: formData
        }));
    }

    function deleteTournament() {
        if (confirm('Are you sure you want to delete this tournament?')) {
            tg.sendData(JSON.stringify({
                action: 'delete_tournament',
                id: document.getElementById('tournament-id').value
            }));
        }
    }

    tg.onEvent('webAppDataReceived', (event) => {
        const data = JSON.parse(event.data);

        if (data.action === 'display_tournaments') {
            const listContainer = document.getElementById('tournaments-list');
            listContainer.innerHTML = '';

            data.tournaments.forEach(tournament => {
                const item = document.createElement('div');
                item.style.padding = '10px';
                item.style.borderBottom = '1px solid #eee';

                const name = document.createElement('strong');
                name.textContent = tournament.event_name;

                const date = document.createElement('div');
                date.textContent = new Date(tournament.event_datetime).toLocaleString();

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => showEditForm(tournament);

                item.appendChild(name);
                item.appendChild(date);
                item.appendChild(editBtn);
                listContainer.appendChild(item);
            });
        }
    });

    // Initial load
    loadTournaments();
</script>
</body>
</html>